<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aztec PFP Wall</title>
<style>
  :root{
    --accent:#6f6ce8; --border:#e8eaf4; --text:#121428; --muted:#a9b0d6;
    --bg:#0b0f14; --panel:#1a1f33cc;
    --zoom:1; /* runtime-controlled */
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family: ui-sans-serif, system-ui; color:#e6eef8; background:var(--bg); }

  .bg{
    position:fixed; inset:0; z-index:-2;
    background:
      radial-gradient(1200px 600px at 20% -10%, #2a245a40, transparent 65%),
      radial-gradient(1000px 600px at 120% 10%, #4b49b830, transparent 60%),
      linear-gradient(160deg,#0b0f14 0%, #0e1320 60%, #0b0f14 100%);
  }
  .bg::after{
    content:""; position:absolute; inset:-10%;
    background:
      linear-gradient(90deg, transparent 0 40%, #6f6ce80d 50%, transparent 60%),
      repeating-linear-gradient(45deg, transparent 0 18px, #6f6ce80a 18px 19px);
    animation: sweep 6s linear infinite; mix-blend-mode: screen;
  }
  @keyframes sweep{ 0%{transform:translateX(-10%);opacity:.5} 50%{opacity:.25} 100%{transform:translateX(10%);opacity:.5} }

  header{ max-width:1100px; margin:24px auto 0; padding:0 16px; }
  h1{ margin:0 0 6px; color:#cfd5ff; font-size:40px; line-height:1.1; }
  .sub{ color:var(--muted); font-weight:600; }

  .wrap{ max-width:1100px; margin:16px auto; padding:0 16px; }
  .panel{
    border:1px solid #ffffff1a; border-radius:14px; padding:12px;
    background:linear-gradient(180deg,#1a1f33cc,#161a2dcc);
    box-shadow:0 8px 24px rgba(0,0,0,.25); backdrop-filter: blur(6px);
  }

  /* Controls row */
  .controls{ display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:center; }
  .controls input{
    height:48px; border-radius:12px; border:1px solid #ffffff22;
    padding:0 14px; font-size:16px; background:#0f1530; color:#e6eaff;
  }
  .controls button{
    height:48px; border-radius:12px; border:none; padding:0 18px; font-size:16px;
    background: var(--accent); color:#fff; font-weight:700; cursor:pointer; transition: transform .15s, background .2s;
  }
  .controls button:hover{ background:#5a58d8; transform: translateY(-1px); }

  /* Zoom control */
  .zoom{
    display:flex; align-items:center; gap:8px; border:1px solid #ffffff22; border-radius:10px; padding:6px 8px; background:#0f1530;
  }
  .zoom button{
    height:32px; padding:0 10px; border-radius:8px; border:1px solid #ffffff22; background:#1b2248; color:#e6eaff; font-weight:800; cursor:pointer;
  }
  .zoom .val{ min-width:46px; text-align:center; color:#cfd5ff; font-weight:800; }

  @media (max-width:640px){
    .controls{ grid-template-columns: 1fr auto; }
    .zoom{ grid-column: 1 / -1; justify-self: start; }
  }

  /* Floating canvas */
  .canvas {
    position: relative;
    height: calc(100vh - 260px); /* a bit taller than before */
    border:1px solid #ffffff14; border-radius:16px;
    overflow:hidden;
    background: radial-gradient(900px 420px at 30% -10%, #262a4a55, transparent 60%);
  }
  .hint { color:#a9b0d6; font-size:13px; margin:8px 0 0 4px; }

  /* Clickable card (anchor) */
  .card{
    position:absolute;
    width: calc(150px * var(--zoom));
    height: calc(190px * var(--zoom));
    border:1px solid #ffffff1f; border-radius:16px; overflow:hidden; background:#0f1530;
    box-shadow:0 12px 30px rgba(0,0,0,.35);
    will-change: transform;
    animation: float var(--dur,8s) ease-in-out infinite;
    transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    text-decoration:none; cursor:pointer; color:#e6eaff;
  }
  .card:hover{
    transform: translate3d(0,0,0) scale(1.04) rotateZ(var(--tilt,0deg));
    box-shadow:0 18px 38px rgba(0,0,0,.45);
    filter: brightness(1.05);
    animation-play-state: paused;
  }
  .pfp{ height: calc(132px * var(--zoom)); background:#000; }
  .pfp img{ width:100%; height:100%; object-fit:cover; display:block; }
  .body{ padding:8px 10px; }
  .name{
    font-weight:900;
    font-size: calc(14px * var(--zoom));
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    max-width: 100%;
  }

  /* Float drift */
  @keyframes float {
    0%   { transform: translate3d(0,0,0) }
    50%  { transform: translate3d(var(--dx, 10px), var(--dy, -12px), 0) }
    100% { transform: translate3d(0,0,0) }
  }

  footer{ text-align:center; margin:16px 0 24px; color:#a9b0d6; font-size:13px; }
  footer a{ color:#cfd5ff; font-weight:700; text-decoration:none; }
</style>
</head>
<body>
<div class="bg"></div>

<header>
  <h1>Aztec PFP Wall</h1>
  <div class="sub">Drop your X handle. Your avatar shows instantly. Control the zoom to fit more cards.</div>
</header>

<div class="wrap panel">
  <form id="form" class="controls">
    <input id="handle" type="text" placeholder="@handle" required />
    <button id="submitBtn" type="submit">Submit</button>

    <div class="zoom" aria-label="Zoom controls">
      <button type="button" id="zoomOut">−</button>
      <div class="val" id="zoomVal">100%</div>
      <button type="button" id="zoomIn">+</button>
    </div>
  </form>
  <div class="hint" id="msg"></div>
</div>

<div class="wrap">
  <div id="canvas" class="canvas"></div>
  <div class="hint">Tip: Use the zoom control to fit more cards on small screens.</div>
</div>

<footer>
  Built by <a href="https://twitter.com/seuncoded" target="_blank" rel="noopener">Seuncoded</a>
</footer>

<script>
let Z = (window.innerWidth <= 640) ? 0.85 : 1;  // default zoom: slightly smaller on phones
const Z_MIN = 0.7, Z_MAX = 1.2, Z_STEP = 0.05;

function setZoom(val){
  Z = Math.max(Z_MIN, Math.min(Z_MAX, val));
  document.documentElement.style.setProperty('--zoom', Z);
  document.getElementById('zoomVal').textContent = Math.round(Z*100) + '%';
  render(true); // re-layout with new sizes
}

async function fetchList(){
  const r = await fetch('/api/list', { cache:'no-store' });
  return r.ok ? r.json() : [];
}

function cardHtml(p, left, top, dx, dy, delay, dur, tilt){
  return `
  <a class="card"
     href="${p.twitter_url}" target="_blank" rel="noopener"
     style="left:${left}px; top:${top}px;
            --dx:${dx}px; --dy:${dy}px;
            --tilt:${tilt}deg;
            animation-delay:${delay}s; --dur:${dur}s">
    <div class="pfp"><img src="${p.pfp_url}" alt="@${p.handle}" loading="lazy"></div>
    <div class="body"><div class="name">@${p.handle}</div></div>
  </a>`;
}

/* compute layout spots based on the *scaled* card size so capacity increases when zooming out */
function layoutCards(items){
  const canvas = document.getElementById('canvas');
  const W = canvas.clientWidth, H = canvas.clientHeight;

  const baseW = 150, baseH = 190, pad = 14;
  const cw = Math.round(baseW * Z);
  const ch = Math.round(baseH * Z);

  const cols = Math.max(1, Math.floor((W - pad) / (cw + pad)));
  const rows = Math.max(1, Math.floor((H - pad) / (ch + pad)));

  const spots = [];
  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      const x = pad + c*(cw+pad);
      const y = pad + r*(ch+pad);
      spots.push([x,y]);
    }
  }

  const order = spots.slice().sort(() => Math.random()-0.5);
  let html = '';

  const n = items.length;
  const cap = Math.max(1, order.length);

  for(let i=0;i<n;i++){
    const base = order[i % cap] || [pad, pad];
    // If over capacity, offset subsequent wraps a bit to reveal extra cards
    const wrap = Math.floor(i / cap);
    const jitterX = (wrap * Math.min(12, Math.max(6, Math.round(16 * Z)))) * (i % 2 ? 1 : -1);
    const jitterY = (wrap * Math.min(16, Math.max(8, Math.round(20 * Z))));

    const left = Math.min(Math.max(base[0] + jitterX, pad), Math.max(pad, W - cw - pad));
    const top  = Math.min(Math.max(base[1] + jitterY, pad), Math.max(pad, H - ch - pad));

    const dx   = Math.round(Math.random()*18 - 9);
    const dy   = Math.round(Math.random()*24 - 12);
    const delay= +(Math.random()*4).toFixed(2);
    const dur  = 7 + Math.round(Math.random()*4);
    const tilt = Math.round(Math.random()*2 - 1) * 2;

    html += cardHtml(items[i], left, top, dx, dy, delay, dur, tilt);
  }
  canvas.innerHTML = html;
}

let lastSnap = "";
function snapshot(items){ return JSON.stringify({ n: items.length, k: items.slice(0,10).map(x=>x.id||x.handle) }); }

async function render(force=false){
  const items = await fetchList();
  const snap = snapshot(items);
  if (force || snap !== lastSnap){
    lastSnap = snap;
    layoutCards(items);
  }
}

async function submitForm(e){
  e.preventDefault();
  const msg = document.getElementById('msg');
  const btn = document.getElementById('submitBtn');
  const handle = document.getElementById('handle').value.trim();

  btn.disabled = true; btn.textContent = 'Submitting…'; msg.textContent = '';
  try{
    const r = await fetch('/api/submit', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ handle })
    });
    const j = await r.json();
    if(!r.ok || !j.ok){ msg.textContent = j.error || 'Failed to submit'; }
    else { msg.textContent = 'Added!'; document.getElementById('form').reset(); render(true); }
  }catch(err){ msg.textContent = 'Network error'; }
  finally{ btn.disabled = false; btn.textContent = 'Submit'; }
}

/* listeners */
document.getElementById('form').addEventListener('submit', submitForm);
document.getElementById('zoomIn').addEventListener('click', ()=> setZoom(Z + Z_STEP));
document.getElementById('zoomOut').addEventListener('click',()=> setZoom(Z - Z_STEP));
window.addEventListener('resize', ()=> render(true));

/* boot */
setZoom(Z);   // sets CSS var + label + triggers first render
</script>
</body>
</html>