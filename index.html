<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aztec PFP Wall</title>
<style>
  :root{
    --accent:#6f6ce8; --border:#e8eaf4; --text:#121428; --muted:#667; --bg:#0b0f14;
    --panel:#ffffff;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family: ui-sans-serif, system-ui; color:#e6eef8; background:var(--bg); }

  /* Animated Aztec-ish background */
  .bg{
    position:fixed; inset:0; z-index:-2;
    background:
      radial-gradient(1200px 600px at 20% -10%, #2a245a40, transparent 65%),
      radial-gradient(1000px 600px at 120% 10%, #4b49b830, transparent 60%),
      linear-gradient(160deg,#0b0f14 0%, #0e1320 60%, #0b0f14 100%);
  }
  .bg::after{
    content:"";
    position:absolute; inset:-10%;
    background:
      linear-gradient(90deg, transparent 0 40%, #6f6ce80d 50%, transparent 60%),
      repeating-linear-gradient(45deg, transparent 0 18px, #6f6ce80a 18px 19px);
    animation: sweep 6s linear infinite;
    mix-blend-mode: screen;
  }
  @keyframes sweep{
    0%{ transform: translateX(-10%); opacity:.5 }
    50%{ opacity:.25 }
    100%{ transform: translateX(10%); opacity:.5 }
  }

  header{ max-width:1100px; margin:24px auto 0; padding:0 16px; }
  h1{ margin:0 0 6px; color:#cfd5ff; font-size:40px; line-height:1.1; }
  .sub{ color:#a9b0d6; font-weight:600; }

  .wrap{ max-width:1100px; margin:16px auto; padding:0 16px; }
  .panel{
    border:1px solid #ffffff1a; border-radius:14px; padding:12px;
    background:linear-gradient(180deg,#1a1f33cc,#161a2dcc);
    box-shadow:0 8px 24px rgba(0,0,0,.25);
    backdrop-filter: blur(6px);
  }

  /* Controls */
  .controls{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
  .controls input{
    height:48px; border-radius:12px; border:1px solid #ffffff22;
    padding:0 14px; font-size:16px; background:#0f1530; color:#e6eaff;
  }
  .controls button{
    height:48px; border-radius:12px; border:none; padding:0 18px; font-size:16px;
    background: var(--accent); color:#fff; font-weight:700; cursor:pointer; transition: transform .15s, background .2s;
  }
  .controls button:hover{ background:#5a58d8; transform: translateY(-1px); }
  @media (max-width:640px){ .controls{ grid-template-columns: 1fr; } }

  /* Floating canvas */
  .canvas {
    position: relative; height: calc(100vh - 230px);
    border:1px solid #ffffff14; border-radius:16px; overflow:hidden;
    background: radial-gradient(900px 420px at 30% -10%, #262a4a55, transparent 60%);
  }
  .hint { color:#a9b0d6; font-size:13px; margin:8px 0 0 4px; }

  /* Card: smaller, with interactive float */
  .card{
    position:absolute; width:150px; height:190px;
    border:1px solid #ffffff1f; border-radius:16px; overflow:hidden; background:#0f1530;
    box-shadow:0 12px 30px rgba(0,0,0,.35);
    will-change: transform;
    animation: float var(--dur,8s) ease-in-out infinite;
    transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
  }
  .card:hover{
    transform: translate3d(0,0,0) scale(1.04) rotateZ(var(--tilt,0deg));
    box-shadow:0 18px 38px rgba(0,0,0,.45);
    filter: brightness(1.05);
    animation-play-state: paused; /* pause drift while hovered */
  }
  .pfp{ height:132px; background:#000; }
  .pfp img{ width:100%; height:100%; object-fit:cover; display:block; }
  .body{ padding:8px 10px; }
  .name{ font-weight:900; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#e6eaff; }
  .link{ display:inline-block; margin-top:4px; font-size:12px; font-weight:800; color:#cfd5ff; text-decoration:none;
         background:#2a2f66; border:1px solid #ffffff22; padding:4px 8px; border-radius:10px; }

  /* Float path (varied per card via CSS vars) */
  @keyframes float {
    0%   { transform: translate3d(0,0,0) }
    50%  { transform: translate3d(var(--dx, 10px), var(--dy, -12px), 0) }
    100% { transform: translate3d(0,0,0) }
  }

  footer{ text-align:center; margin:16px 0 24px; color:#a9b0d6; font-size:13px; }
  footer a{ color:#cfd5ff; font-weight:700; text-decoration:none; }
</style>
</head>
<body>
<div class="bg"></div>

<header>
  <h1>Aztec PFP Wall</h1>
  <div class="sub">Drop your X handle. Your avatar shows instantly. The wall updates itself.</div>
</header>

<div class="wrap panel">
  <form id="form" class="controls">
    <input id="handle" type="text" placeholder="@handle" required />
    <button id="submitBtn" type="submit">Submit</button>
  </form>
  <div class="hint" id="msg"></div>
</div>

<div class="wrap">
  <div id="canvas" class="canvas"></div>
  <div class="hint">Cards float with gentle drift. The wall refreshes every 30s or when someone submits.</div>
</div>

<footer>
  Built by <a href="https://twitter.com/seuncoded" target="_blank" rel="noopener">Seuncoded</a>
</footer>

<script>
let lastSnapshot = "";      // for change detection
let liveTimer   = null;     // polling timer

async function fetchList(){
  const r = await fetch('/api/list', { cache:'no-store' });
  return r.ok ? r.json() : [];
}

function cardHtml(p, left, top, dx, dy, delay, dur, tilt){
  return `
  <article class="card"
    style="left:${left}px; top:${top}px;
           --dx:${dx}px; --dy:${dy}px;
           --tilt:${tilt}deg;
           animation-delay:${delay}s; --dur:${dur}s">
    <div class="pfp"><img src="${p.pfp_url}" alt="@${p.handle}" loading="lazy"></div>
    <div class="body">
      <div class="name">@${p.handle}</div>
      <a class="link" href="${p.twitter_url}" target="_blank" rel="noopener">Profile</a>
    </div>
  </article>`;
}

/* pack cards into a coarse grid to avoid overlaps, then add drift */
function layoutCards(items){
  const canvas = document.getElementById('canvas');
  const W = canvas.clientWidth, H = canvas.clientHeight;
  const cw = 150, ch = 190, pad = 14;

  const cols = Math.max(1, Math.floor((W - pad) / (cw + pad)));
  const rows = Math.max(1, Math.floor((H - pad) / (ch + pad)));
  const spots = [];
  for(let r=0; r<rows; r++){
    for(let c=0; c<cols; c++){
      const x = pad + c*(cw+pad);
      const y = pad + r*(ch+pad);
      spots.push([x,y]);
    }
  }

  // randomize which spots are filled
  const order = spots.sort(() => Math.random()-0.5);
  const n = Math.min(items.length, order.length);

  let html = '';
  for(let i=0;i<n;i++){
    const [left, top] = order[i];
    const dx   = Math.round(Math.random()*18 - 9);    // -9..9
    const dy   = Math.round(Math.random()*24 - 12);   // -12..12
    const delay= +(Math.random()*4).toFixed(2);
    const dur  = 7 + Math.round(Math.random()*4);     // 7..11s
    const tilt = Math.round(Math.random()*2 - 1) * 2; // -2,0,2 deg
    html += cardHtml(items[i], left, top, dx, dy, delay, dur, tilt);
  }
  canvas.innerHTML = html;
}

function snapshot(items){
  // small hash: count + first 10 ids/handles
  return JSON.stringify({
    n: items.length,
    k: items.slice(0,10).map(x=>x.id||x.handle)
  });
}

async function render(force=false){
  const items = await fetchList();
  const snap = snapshot(items);
  if (force || snap !== lastSnapshot){
    lastSnapshot = snap;
    layoutCards(items);
  }
}

async function submitForm(e){
  e.preventDefault();
  const msg = document.getElementById('msg');
  const btn = document.getElementById('submitBtn');
  const handle = document.getElementById('handle').value.trim();

  btn.disabled = true; btn.textContent = 'Submittingâ€¦'; msg.textContent = '';
  try{
    const r = await fetch('/api/submit', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ handle })
    });
    const j = await r.json();
    if(!r.ok || !j.ok){ msg.textContent = j.error || 'Failed to submit'; }
    else { msg.textContent = 'Added!'; document.getElementById('form').reset(); render(true); }
  }catch(err){ msg.textContent = 'Network error'; }
  finally{ btn.disabled = false; btn.textContent = 'Submit'; }
}

/* Live auto-refresh every 30s */
function startLive(){
  if (liveTimer) clearInterval(liveTimer);
  liveTimer = setInterval(()=> render(false), 30000);
}

document.getElementById('form').addEventListener('submit', submitForm);
window.addEventListener('resize', ()=>render(true));
render(true);
startLive();
</script>
</body>
</html>